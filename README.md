# ⚡️ 電力需要・供給・市場価格の同時予測
## Temporal Fusion Transformer-multi (TFT-multi) を用いたマルチ変数時系列予測

---

## 📘 概要：なぜ同時予測が必要か？

本研究では、**He & Chiang [2] の提案に基づく Temporal Fusion Transformer-multi(TFT-multi)** を用いて、日本の電力市場における電力需要・供給・市場価格の3変数を同時に予測します。

従来の単変量の個別予測モデルでは、需給逼迫に伴う価格上昇などの変数間の相互依存関係が十分に捉えられないことが課題として指摘されています。
その結果、予測全体の**整合性(需給バランスと価格反応の一貫性など)** が損なわれる課題に繋がります。

本研究はTFT-multiを採用して、3変数を1つのモデルで同時に学習・出力することで、変数間の依存構造（需要と供給と価格）、地域差の構造、時系列パターンといった要素を総合的に学習し、精度と整合性を両立した予測を実現します。　

---

## 📊 使用データと共変量の設計

### 🔹 目的変数（Target Variables）
* 電力需要（Demand）
* 電力供給（Supply）
* 市場価格（Price）

### 🔧 共変量の設計ポイント
TFT-multi の性能を最大化するため、**過去の動的共変量**、**既知未来の動的共変量**、および **静的共変量** を組み合わせて設計しました。特に、気象、時間情報、地域差、発電構成を与えることで、時系列の特徴抽出を強化しています。

#### 1. 過去の動的共変量（Known Past Dynamic Covariates）
予測時点までに観測値が揃っている時系列データ。
- **履歴データ:** 過去の需給実績（エリア需要）、価格実績（価格(円/kWh)）  
- **系統情報:** 過去の連系線潮流、揚水、蓄電池の運用状況  
- **気象データ:** 過去の気温、降水量、風速、天気  
- **電源構成:** 過去の原子力、火力、水力、地熱、バイオマス、太陽光・風力の発電実績や制御量


#### 2. 既知未来の動的共変量（Known Future Dynamic Covariates）
予測ホライズン内でも値が既知の時系列データ。
* カレンダー情報（曜日・祝日・月・日・時）

#### 3. 静的共変量（Static Covariates）
時間軸で変化しない、または緩やかに変化する要素。
* 地域ID（四国 / 中国）
* 人口規模

---

## 🔬 データ処理と予測設定

### 📅 期間 & 分割
* **データ:** 1 年間の **1 時間値データ**
* **分割:** 学習 90% / テスト 10%
* **データ拡張:** **一日ごとにウィンドウをスライド** させて学習データを増強（Data Augmentation）

### 🔄 正規化手法の検討と課題
データスケールの異なる変数を扱うため、以下の3手法を比較検討しました。

1. 系列全体 Min-Max 正規化
2. 系列全体 標準化（Z-score）
3. 地域別 標準化

**検証結果：**
「1. 系列全体 Min-Max 正規化」が最もトレンドの形状（山・谷）を捉えることができましたが、**経済規模の小さい四国エリア**で予測値が上振れ（過大評価）する課題が確認されました。<br>
※ 後述の「地域別スケール補正」にて対策予定です。

### 🔮 予測設定
* **入力期間（Lookback）:** 過去 36 時間
* **出力期間（Horizon）:** 未来 12 時間 （**Multi-horizon 予測**）

---

## 🤖 モデル構成と学習条件

### **TFT-multi の採用**
* **機能:** マルチ変数の同時予測に対応。**Variable Selection Network** による重要特徴量の自動選択、**Attention 機構** による長期依存関係の学習。
* **特徴:** 外部要因の考慮や相関の考慮が得意

### **分位点回帰（Quantile Regression）**
* **目的:** 単一点予測だけでなく、予測の不確実性（信頼区間）を提示するため。
* **学習:** $q = 0.1, 0.5, 0.75$ の分位点を同時学習。

### **学習条件**
### 学習条件


- **最適化手法:** Adam（学習率 $\text{lr}=10^{-4}$）  
- **エポック数:** 100  
- **マルチヘッドアテンション:** ヘッド数 = 2  
- **LSTMレイヤー:** 2層  
- **ドロップアウト率:** 0.3

**性能:**  
- 最終検証誤差（Validation Loss） 約 0.05


---

## 📈 結果：MAEと傾向分析

TFT-multi は 3 変数（需要・純供給・価格）の変動方向の整合性を概ね保ちながら予測を行いました。<br>
需要が上昇し供給が低下する局面では、価格も上昇方向に動くなど、市場原理に沿った方向性の学習は確認されています。<br>
結果は result ディレクトリに格納しています。

### 🔹 地域別所見

* **中国エリア**
    <br> 最も安定した高精度な予測を達成しました。全体的に需要・供給・価格のすべてでMAEが低く、再エネ比率の影響で変動しやすい供給曲線に対しても、その全体の形状を的確に追従しています。<br>
      しかし、result/中国結果/結果3.png のように一部の急峻な変動を捉えきれない事例も確認されました。この点を将来的なモデル改善の主要課題と位置づけ、今後はパラメータ調整やデータ拡充を進めています。

* **四国エリア**
    <br> 需要・供給の一部に上振れ（過小推定）傾向が見られました。
      <br>ただしピーク・ボトムのタイミングは実測と一致しており、スケールやノイズの影響による偏りが大きいと推測されます。この点は、地域スケール差の補正によって改善中です。

### 📊 数値評価（Mean Absolute Error: MAE）

| 地域 | 変数 | 平均 MAE | 中央値 MAE | n |
| :--- | :--- | :--- | :--- | :--- |
| **中国** | 需要 | 174.48 | 154.50 | 35 |
| **中国** | 供給 | 290.41  | 272.69 | 35 |
| **中国** | 価格 | 2.03   | 1.67   | 35 |
| **四国** | 需要 | 24.28  | 21.04  | 35 |
| **四国** | 供給 | 74.90  | 78.44  | 35 |
| **四国** | 価格 | 2.10   | 1.95   | 35 |

---

## 🚀 今後の取り組みと展望（Future Work）

### 🧪 現在進行中の取り組み（Current Initiatives）

**1. 地域スケール差の補正（Region-Affine Correction）**　地域ごとに需要・供給・価格のスケール（平均値・変動幅）が大きく異なるため、  
本研究では **正規化によって生じる地域間のスケール差を補正する仕組み** を  **TFT-multi の最終層に組み込みます**。

<div align="center">

$$
\displaystyle
y^{\mathrm{final}}_{r} = a_{r}\, y^{\mathrm{model}}_{r} + b_{r}
$$

</div>

$a_r$ は地域 $r$ における出力スケールの伸縮を調整する係数、
$b_r$ は地域特有の平均的なズレ（オフセット）を補正するための係数です。  
両者は学習過程において自動的に推定され、  **地域ごとに最も適したスケーリングが適用される構造**にします。

**2. 解釈性の向上（Explainability）**
ブラックボックスになりがちな深層学習モデルに対し、**Variable Selection Network** の寄与度や **Attention Weight** を可視化し、**「何が需給逼迫の予兆となったか」**を説明可能にします。

**3. 整合性指標（Consistency Index）の開発**
物理的な需給バランスと経済的な価格反応の整合性を測るため、「需要 $\approx$ 供給 + 価格弾力性」に基づく独自の評価指標を開発・導入します。

**4. 既存手法との比較検証（Benchmark Comparison）**
LightGBMやLSTMなどの単変量モデル、あるいは他の多変量モデルと比較実験を行います。「予測精度（MAE/RMSE）」だけでなく、「3変数の整合性が保たれているか」という観点でも優位性を評価します。

**5. データ増強とパラメータ最適化（Data Expansion & Hyperparameter Optimization）**
result/中国結果/結果3.png のように捉えきれないケースに対応するため、以下の改善を進めています。
* 学習データの拡充
 * ハイパーパラメータ探索によるモデルの高分解能化

### 🔮 長期的な展望（Roadmap）

**6. 対象地域の拡大**
現在の2エリアから、近畿・九州・北海道などへ対象を広げ、マルチリージョンモデルによる広域需給の同時予測を目指します。

**7. 連系線の因果モデル化**
四国 $\leftrightarrow$ 中国間の潮流（Interconnection Flow）が、各エリアの価格・需給に与える**双方向の因果関係**をモデル構造に組み込みます。

**8. 中〜長期予測への拡張（24〜72 時間）**
予測ホライズンを延長し、災害・逼迫時の**早期警戒アラート**や、計画停電・需給調整の意思決定支援システムへの応用を検討します。

**⚠️ 注意事項（Current Status）**

※ 上記の機能のは現在実装・検証中であり、  
動作が保証されていません。  
そのため、現時点で GitHub に公開しているコードには含めていません。

---

## 📚 参考文献

[1]. Bryan Lim, et al., *Temporal Fusion Transformers for Interpretable Multi-horizon Time Series Forecasting*, 2021.<br>
[2]. He & Chiang, *TFT-multi: Adapting Transformers for Multivariate Time Series*, 2024.　　<br>
[3]. データソース: 四国電力送配電, 中国電力ネットワーク, JEPX (日本卸電力取引所), 気象庁<br>
